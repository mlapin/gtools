#!/bin/bash
#
# Submits grid engine jobs
set -e
GT_NAME="${0##*/}"
name="${GT_NAME}"

# Enable debug mode
if [[ -n "${DEBUG}" ]]; then
  set -x
fi

usage() {
  cat <<EOF
usage: ${name/-/ } [--version] [--help]
          [--config <path>] [--dry-run] [--verbose]
          <command> [<args>]

Commands:
   check      Check if gtools are ready to use
   config     Create a user config file
   cmd        Submit a single command
   file       Submit a set of commands listed in a file
   mcc        Compile a Matlab function
   st         Show the status of submitted jobs
   re         Reschedule failed jobs
   rm         Remove jobs
   alter      Modify jobs

See \`${name/-/ } help <command>' for more information on a specific command.
EOF
}

show_help() {
  case "$1" in
    '')
      usage
      ;;
    gt*)
      man "${MAN_DIR}/gt.1"
      ;;
    *)
      if [[ -e "${MAN_DIR}/gt-$1.1" ]]; then
        man "${MAN_DIR}/gt-$1.1"
        break
      else
        echo "${name}: no manual entry for '$1'." >&2
        exit 1
      fi
      ;;
  esac
}

main() {
  if [[ -z "$1" ]]; then
    usage
    exit 1
  fi

  abspath="$(readlink -f "$0")"
  LOCAL_DIR="${abspath%/*}" # used in the setup script
  . "${LOCAL_DIR}/gt-setup.sh" || exit 1

  read_config "$@"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --version)
        echo "${name}: gtools version ${VERSION}"
        break
        ;;
      --help|help)
        shift
        show_help "$@"
        break
        ;;
      --conf*)
        shift
        CONFIG_FILE="$1"
        read_config "$@" # re-read the config
        ;;
      --dry*)
        DRY_RUN=1
        ;;
      --verbose)
        VERBOSE=1
        ;;
      *)
        if [[ -e "${LOCAL_DIR}/gt-$1.sh" ]]; then
          local cmd="$1"
          shift
          verbose "executing: ${LOCAL_DIR}/gt-${cmd}.sh"
          . "${LOCAL_DIR}/gt-${cmd}.sh" "$@"
          break
        else
          unknown_command "$1"
          exit 1
        fi
        ;;
    esac
    shift
  done
}

main "$@"
